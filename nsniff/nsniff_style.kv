#:import math math

<MainView@BoxLayout>:
    orientation: 'vertical'
    spacing: '5dp'
    canvas:
        Color:
            rgba: app.theme.primary_text
        Rectangle:
            pos: self.pos
            size: self.size
    StackLayout:
        size_hint_y: None
        height: '34dp'
        orientation: 'lr-tb'
        padding: '10dp', 0
        canvas:
            Color:
                rgba: app.theme.primary
            Rectangle:
                pos: self.pos
                size: self.size
        FlatDivider:
            color: app.theme.divider
        FlatLabel:
            text: str(error_indicator.count)
            size_hint_x: None
            width: self.texture_size[0]
            padding: '1dp', '5dp'
            flat_color: app.theme.text_primary
        FlatErrorIndicatorPopup:
            id: error_indicator
            scale_down_color: True
            source: 'flat_alert.png'
            flat_color: app.theme.accent
            on_kv_post: app.error_indicator = self
            on_release: self.count = 0
    BoxLayout:
        orientation: 'horizontal'
        DeviceDisplay


<DeviceDisplay>:
    orientation: 'vertical'
    on_kv_post: app.device = self.__self__
    spacing: '5dp'
    padding: '10dp', 0
    BoxLayout:
        size_hint_y: None
        height: '34dp'
        spacing: '5dp'
        AccentThemedToggleButton:
            text: 'Virtual device'
            state: 'down' if root.virtual else 'normal'
            size_hint_x: None
            width: self.texture_size[0]
            padding_x: '10dp'
            on_state: root.virtual = self.state == 'down'
        FlatSizedTextInput:
            background_color: app.theme.primary_text
            size_hint_x: None
            width: '100dp'
            text: root.com_port
            on_text: root.com_port = self.text
            hint_text: 'port'
        FlatImageToggleButton:
            source: 'flat_play.png' if self.state == 'normal' else 'flat_stop.png'
            flat_color: app.theme.accent
            on_release: root.start() if self.state == 'down' else root.stop()
            hover_text: '[b]start[/b] sensor' if self.state == 'normal' else '[b]stop[/b] sensor'
        Widget
        ThemedLabel:
            size_hint_x: None
            width: self.texture_size[0]
            text: 'ID: {}'.format(root.device.device_id) if root.device is not None else 'ID: none'
        ThemedLabel:
            size_hint_x: None
            width: self.texture_size[0]
            text: 'Temp: {:0.1f}'.format(root.device.temp) if root.device is not None else 'Temp: 0'
        ThemedLabel:
            size_hint_x: None
            width: self.texture_size[0]
            text: 'Humidity: {:0.1f}'.format(root.device.humidity) if root.device is not None else 'Tumidity: 0'
        ThemedLabel:
            size_hint_x: None
            width: self.texture_size[0]
            text: 'Clock: {:0.1f}'.format(root.t)
    BoxLayout:
        size_hint_y: None
        height: '34dp'
        spacing: '5dp'
        AccentThemedToggleButton:
            text: 'logarithmic'
            state: 'down' if root.log_z else 'normal'
            size_hint_x: None
            width: self.texture_size[0]
            padding_x: '10dp'
            on_state: root.log_z = self.state == 'down'
        AccentThemedToggleButton:
            text: 'Auto scale'
            state: 'down' if root.auto_scale else 'normal'
            size_hint_x: None
            width: self.texture_size[0]
            padding_x: '10dp'
            on_state: root.auto_scale = self.state == 'down'
        AccentThemedButton:
            text: 'Rescale'
            size_hint_x: None
            width: self.texture_size[0]
            padding_x: '10dp'
            on_state: root.draw_data()
    Widget:
        size_hint_y: None
        height: '20dp'
        canvas:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                texture: root.scale_tex
    ScrollView:
        bar_width: '20'
        Graph:
            on_kv_post: root.create_plot(self.__self__)
            size_hint: None, None
            width: max(self.parent.width, dp(50 + root.num_points))
            height: max(self.parent.height, dp(50 + 64))
            xlabel: 'Time (s)'
            ylabel: 'Sensor ID'
            x_ticks_minor: 5
            x_ticks_major: round((self.xmax - self.xmin) / max(self.width / dp(200), 1))
            y_ticks_major: 10
            y_grid_label: True
            x_grid_label: True
            padding: 5
            ymin: 1
            ymax: 32
            xmin: 0
            xmax: 100
            tick_color: app.theme.accent[:3]
            border_color: app.theme.accent[:3]
            label_options: {'color': app.theme.text_primary[:3], 'bold': True}
            background_color: app.theme.primary_text
